# [Question]: Please calculate the fatality rate for motorcycle collisions, separated by helmet usage. Specifically, calculate two percentages: 1) the percentage of motorcyclist fatalities in collisions where parties (drivers or passengers) were wearing helmets, and 2) the percentage of motorcyclist fatalities in collisions where parties were not wearing helmets. For each group, compute this by dividing the total number of motorcyclist fatalities by the total number of collisions involving that group. Use the parties table to determine helmet usage (from party_safety_equipment fields).
# [Schema links]: ['COLLISIONS.case_id', 'COLLISIONS.motorcyclist_killed_count', 'COLLISIONS.motorcycle_collision', 'PARTIES.case_id', 'PARTIES.party_safety_equipment_1', 'PARTIES.party_safety_equipment_2', 'PARTIES.party_age']
# [Analysis]: # Output: Letâ€™s think step by step.
1. Identify the relevant tables: `COLLISIONS` (case_id, motorcyclist_killed_count, motorcycle_collision) and `PARTIES` (case_id, party_safety_equipment_1, party_safety_equipment_2, party_age).
2. Join `COLLISIONS` and `PARTIES` on `case_id` to combine collision data with party safety equipment information.
3. Filter for motorcycle collisions only using `COL.motorcycle_collision = '1'` and ensure valid party data with `PARTY.party_age IS NOT NULL`.
4. Create two case statements to flag helmet usage: one for "helmet used" (checking for 'driver, motorcycle helmet used' or 'passenger, motorcycle helmet used' in either safety equipment field) and another for "helmet not used" (checking for corresponding 'not used' values).
5. Group the results by case_id, motorcyclist_killed_count, and the safety equipment fields to handle multiple parties per collision.
6. Use a CTE named `BASE` to store these intermediate results with case_id, motorcyclist_killed_count, and the helmet usage flags.
7. Calculate the percentage for helmet used group: sum motorcyclist_killed_count where helmet_used=1, divide by count of collisions where helmet_used=1 (using NULLIF to avoid division by zero), and multiply by 100.
8. Similarly calculate the percentage for helmet not used group: sum motorcyclist_killed_count where helmet_not_used=1, divide by count of collisions where helmet_not_used=1.
9. Round both percentages to 2 decimal places for the final output.
10. Select both calculated percentages in the final query.
# [Sql]: WITH BASE AS (     SELECT          COL."case_id" AS "case_id",         COL."motorcyclist_killed_count" AS "motorcyclist_killed_count",         CASE WHEN PARTY."party_safety_equipment_1" = 'driver, motorcycle helmet used' THEN 1              WHEN PARTY."party_safety_equipment_2" = 'driver, motorcycle helmet used' THEN 1              WHEN PARTY."party_safety_equipment_1" = 'passenger, motorcycle helmet used' THEN 1              WHEN PARTY."party_safety_equipment_2" = 'passenger, motorcycle helmet used' THEN 1              ELSE 0 END AS "helmet_used",         CASE WHEN PARTY."party_safety_equipment_1" = 'driver, motorcycle helmet not used' THEN 1              WHEN PARTY."party_safety_equipment_2" = 'driver, motorcycle helmet not used' THEN 1              WHEN PARTY."party_safety_equipment_1" = 'passenger, motorcycle helmet not used' THEN 1              WHEN PARTY."party_safety_equipment_2" = 'passenger, motorcycle helmet not used' THEN 1              ELSE 0 END AS "helmet_not_used"     FROM CALIFORNIA_TRAFFIC_COLLISION.CALIFORNIA_TRAFFIC_COLLISION.COLLISIONS COL     JOIN CALIFORNIA_TRAFFIC_COLLISION.CALIFORNIA_TRAFFIC_COLLISION.PARTIES PARTY         ON COL."case_id" = PARTY."case_id"     WHERE          COL."motorcycle_collision" = '1'         AND PARTY."party_age" IS NOT NULL     GROUP BY 1, 2, PARTY."party_safety_equipment_1", PARTY."party_safety_equipment_2" ) SELECT      ROUND(SUM(CASE WHEN "helmet_used" = 1 THEN "motorcyclist_killed_count" ELSE 0 END) * 100.0 / NULLIF(COUNT(CASE WHEN "helmet_used" = 1 THEN "case_id" END), 0), 2) AS "percent_killed_helmet_used",     ROUND(SUM(CASE WHEN "helmet_not_used" = 1 THEN "motorcyclist_killed_count" ELSE 0 END) * 100.0 / NULLIF(COUNT(CASE WHEN "helmet_not_used" = 1 THEN "case_id" END), 0), 2) AS "percent_killed_helmet_not_used" FROM      BASE