# [Question]: What were the monthly add-to-cart and purchase conversion rates, calculated as a percentage of pageviews on product details, from January to March 2017?
# [Schema links]: ["ga_sessions_2017*.date", "ga_sessions_2017*.hits.eCommerceAction.action_type", "ga_sessions_2017*.hits.product.productRevenue"]
# [Analysis]: Letâ€™s think step by step.
1. Extract the month from the `date` field using `PARSE_DATE` and format as 'YYYYMM' for grouping.
2. Filter sessions between January 1 and March 31, 2017, using `_table_suffix` between '0101' and '0331'.
3. Calculate product detail pageviews by counting hits with `action_type = '2'` (product detail view).
4. Calculate add-to-cart actions by counting hits with `action_type = '3'` (add to cart).
5. Calculate purchases by counting hits with `action_type = '6'` (purchase) and non-null `productRevenue`.
6. Create CTEs for each metric (product views, add-to-cart, purchases) grouped by month.
7. Join the CTEs on the month to align the counts for the same period.
8. Compute conversion rates as (add-to-cart / product views * 100) and (purchases / product views * 100).
9. Round the results to two decimal places and order by month.
# [Sql]: WITH   cte1 AS     (SELECT       CONCAT(EXTRACT(YEAR FROM (PARSE_DATE('%Y%m%d', date))),'0',                 EXTRACT(MONTH FROM (PARSE_DATE('%Y%m%d', date)))) AS month,       COUNT(hits.eCommerceAction.action_type) AS num_product_view     FROM `bigquery-public-data.google_analytics_sample.ga_sessions_2017*`,       UNNEST(hits) AS hits     WHERE _table_suffix BETWEEN '0101' AND '0331'       AND hits.eCommerceAction.action_type = '2'     GROUP BY month),   cte2 AS     (SELECT       CONCAT(EXTRACT(YEAR FROM (PARSE_DATE('%Y%m%d', date))),'0',                 EXTRACT(MONTH FROM (PARSE_DATE('%Y%m%d', date)))) AS month,       COUNT(hits.eCommerceAction.action_type) AS num_addtocart     FROM `bigquery-public-data.google_analytics_sample.ga_sessions_2017*`,       UNNEST(hits) AS hits     WHERE _table_suffix BETWEEN '0101' AND '0331'       AND hits.eCommerceAction.action_type = '3'     GROUP BY month),   cte3 AS     (SELECT       CONCAT(EXTRACT(YEAR FROM (PARSE_DATE('%Y%m%d', date))),'0',                 EXTRACT(MONTH FROM (PARSE_DATE('%Y%m%d', date)))) AS month,       COUNT(hits.eCommerceAction.action_type) AS num_purchase     FROM `bigquery-public-data.google_analytics_sample.ga_sessions_2017*`,       UNNEST(hits) AS hits,       UNNEST(hits.product) AS product     WHERE _table_suffix BETWEEN '0101' AND '0331'       AND hits.eCommerceAction.action_type = '6'       AND product.productRevenue IS NOT NULL     GROUP BY month) SELECT    ROUND((num_addtocart/num_product_view * 100),2) AS add_to_cart_rate,   ROUND((num_purchase/num_product_view * 100),2) AS purchase_rate FROM cte1   LEFT JOIN cte2   USING(month)    LEFT JOIN cte3   USING(month) ORDER BY month;