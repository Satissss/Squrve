# [Question]: which visitor IDs belong to users whose first transaction occurred on a mobile device on a later date than their first visit?
# [Schema links]: ["google_analytics_sample.ga_sessions_*.fullvisitorid", "google_analytics_sample.ga_sessions_*.date", "google_analytics_sample.ga_sessions_*.device.deviceCategory", "google_analytics_sample.ga_sessions_*.hits.transaction.transactionId"]
# [Analysis]: Letâ€™s think step by step.
1. Identify the first visit date for each visitor by selecting the minimum date grouped by fullvisitorid from the sessions table.
2. Determine the earliest transaction date for each visitor by filtering hits with transactionId and selecting the minimum date grouped by fullvisitorid.
3. Extract the device category for each transaction by joining the sessions table with unnested hits where transactionId exists, capturing deviceCategory alongside the transaction date.
4. Combine the first visit dates, transaction dates, and corresponding device categories using joins to link visitor IDs and matching transaction dates.
5. Calculate the date difference between the first transaction date and first visit date to check if it is positive (indicating a later transaction date).
6. Filter results to include only entries where the device category is "mobile" and the transaction occurred after the first visit.
# [Sql]: WITH    visit AS (     SELECT fullvisitorid, MIN(date) AS date_first_visit     FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*`      GROUP BY fullvisitorid   ),      transactions AS (     SELECT fullvisitorid, MIN(date) AS date_transactions, 1 AS transaction     FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*` AS ga,      UNNEST(ga.hits) AS hits      WHERE hits.transaction.transactionId IS NOT NULL      GROUP BY fullvisitorid   ),    device_transactions AS (     SELECT DISTINCT fullvisitorid, date, device.deviceCategory AS device_transaction     FROM `bigquery-public-data.google_analytics_sample.ga_sessions_*` AS ga,      UNNEST(ga.hits) AS hits      WHERE hits.transaction.transactionId IS NOT NULL   ),    visits_transactions AS (     SELECT visit.fullvisitorid, date_first_visit, date_transactions, device_transaction     FROM visit      LEFT JOIN transactions ON visit.fullvisitorid = transactions.fullvisitorid     LEFT JOIN device_transactions ON visit.fullvisitorid = device_transactions.fullvisitorid      AND transactions.date_transactions = device_transactions.date   )  SELECT fullvisitorid  FROM visits_transactions WHERE DATE_DIFF(PARSE_DATE('%Y%m%d', date_transactions), PARSE_DATE('%Y%m%d', date_first_visit), DAY) > 0 AND device_transaction = "mobile";