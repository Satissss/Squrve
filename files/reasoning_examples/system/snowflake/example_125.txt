# [Question]: Which are the top five states with the greatest average difference in median income between 2015 and 2018 at the ZIP code level, and what is the corresponding average number of vulnerable employees across wholesale trade, natural resources and construction, arts and entertainment, information, and retail trade industries in 2017 according to the ACS Five-Year Estimates and ZIP code boundaries data?
# [Schema links]: ["CENSUS_BUREAU_ACS.ZIP_CODES_2018_5YR.geo_id", "CENSUS_BUREAU_ACS.ZIP_CODES_2018_5YR.median_income", "CENSUS_BUREAU_ACS.ZIP_CODES_2015_5YR.geo_id", "CENSUS_BUREAU_ACS.ZIP_CODES_2015_5YR.median_income", "CENSUS_BUREAU_ACS.ZIP_CODES_2017_5YR.geo_id", "CENSUS_BUREAU_ACS.ZIP_CODES_2017_5YR.employed_wholesale_trade", "CENSUS_BUREAU_ACS.ZIP_CODES_2017_5YR.occupation_natural_resources_construction_maintenance", "CENSUS_BUREAU_ACS.ZIP_CODES_2017_5YR.employed_arts_entertainment_recreation_accommodation_food", "CENSUS_BUREAU_ACS.ZIP_CODES_2017_5YR.employed_information", "CENSUS_BUREAU_ACS.ZIP_CODES_2017_5YR.employed_retail_trade", "GEO_US_BOUNDARIES.ZIP_CODES.zip_code", "GEO_US_BOUNDARIES.ZIP_CODES.state_name"]
# [Analysis]: Letâ€™s think step by step.
1. Identify the tables and columns for median income in 2015 and 2018: `ZIP_CODES_2015_5YR` and `ZIP_CODES_2018_5YR` with `geo_id` and `median_income`.
2. Create CTEs `acs_2015` and `acs_2018` to extract median income values for each year with their respective geo_ids.
3. Calculate the median income difference per ZIP code by joining `acs_2015` and `acs_2018` on `geo_id`, subtracting 2015 from 2018 to get `median_income_diff`.
4. Compute the average of `median_income_diff` per ZIP code in `median_income_diff_by_zipcode` CTE.
5. Join 2017 employment data (`ZIP_CODES_2017_5YR`) with ZIP code boundaries (`ZIP_CODES`) to link geo_ids with state names.
6. Calculate the weighted average of vulnerable employees using coefficients for each specified industry column in 2017 data.
7. Create `base_census` CTE to aggregate average median income difference and weighted vulnerable employees by state.
8. Select top five states ordered by `avg_median_income_diff` descending, including corresponding `avg_vulnerable` values.
# [Sql]: WITH median_income_diff_by_zipcode AS (   WITH acs_2018 AS (     SELECT       "geo_id",       "median_income" AS "median_income_2018"     FROM       CENSUS_BUREAU_ACS_2.CENSUS_BUREAU_ACS."ZIP_CODES_2018_5YR"   ),   acs_2015 AS (     SELECT       "geo_id",       "median_income" AS "median_income_2015"     FROM       CENSUS_BUREAU_ACS_2.CENSUS_BUREAU_ACS."ZIP_CODES_2015_5YR"   ),   acs_diff AS (     SELECT       a18."geo_id",       (a18."median_income_2018" - a15."median_income_2015") AS "median_income_diff"     FROM       acs_2018 a18     JOIN       acs_2015 a15 ON a18."geo_id" = a15."geo_id"   )   SELECT     "geo_id",     AVG("median_income_diff") AS "avg_median_income_diff"   FROM     acs_diff   WHERE     "median_income_diff" IS NOT NULL   GROUP BY "geo_id" ), base_census AS (   SELECT     geo."state_name",     AVG(i."avg_median_income_diff") AS "avg_median_income_diff",     AVG(       "employed_wholesale_trade" * 0.38423645320197042 +       "occupation_natural_resources_construction_maintenance" * 0.48071410777129553 +       "employed_arts_entertainment_recreation_accommodation_food" * 0.89455676291236841 +       "employed_information" * 0.31315240083507306 +       "employed_retail_trade" * 0.51     ) AS "avg_vulnerable"   FROM     CENSUS_BUREAU_ACS_2.CENSUS_BUREAU_ACS."ZIP_CODES_2017_5YR" AS census   JOIN     median_income_diff_by_zipcode i ON CAST(census."geo_id" AS STRING) = i."geo_id"   JOIN     CENSUS_BUREAU_ACS_2.GEO_US_BOUNDARIES."ZIP_CODES" geo ON census."geo_id" = geo."zip_code"   GROUP BY geo."state_name" )  SELECT    "state_name",   "avg_median_income_diff",   "avg_vulnerable" FROM    base_census ORDER BY    "avg_median_income_diff" DESC LIMIT 5;