# [Question]: Identify the case barcodes from the TCGA-LAML study with the highest weighted average copy number in cytoband 15q11 on chromosome 15, using segment data and cytoband overlaps from TCGA's genomic and Mitelman databases.
# [Schema links]: [TCGA_VERSIONED.COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23.case_barcode, TCGA_VERSIONED.COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23.chromosome, TCGA_VERSIONED.COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23.start_pos, TCGA_VERSIONED.COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23.end_pos, TCGA_VERSIONED.COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23.copy_number, TCGA_VERSIONED.COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23.project_short_name, PROD.CYTOBANDS_HG38.chromosome, PROD.CYTOBANDS_HG38.cytoband_name, PROD.CYTOBANDS_HG38.hg38_start, PROD.CYTOBANDS_HG38.hg38_stop]
# [Analysis]: Letâ€™s think step by step.
1. Identify the relevant tables: `TCGA_VERSIONED.COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23` (case_barcode, chromosome, start_pos, end_pos, copy_number, project_short_name) and `PROD.CYTOBANDS_HG38` (chromosome, cytoband_name, hg38_start, hg38_stop).
2. Filter the copy number segments to only include records from the TCGA-LAML study using `project_short_name = 'TCGA-LAML'`.
3. Create a CTE (`copy`) to group segment data by case_barcode, chromosome, start_pos, end_pos and calculate the maximum copy_number for each segment.
4. Extract cytoband data for chromosome 15 and cytoband 15q11 into a CTE (`cytob`), including their genomic coordinates.
5. Join the filtered copy segments with cytobands on matching chromosomes to identify overlapping regions between segments and the target cytoband 15q11.
6. Calculate the overlap length between each segment and cytoband using the formula for interval intersection in genomic coordinates.
7. Compute the weighted average copy number for each case_barcode by summing (overlap * copy_number) divided by total overlap length for the cytoband.
8. Filter results to only include entries where chromosome is 'chr15' and cytoband_name is '15q11'.
9. Sort the results by the computed weighted copy_number in descending order and select the top case_barcode.
# [Sql]: WITH copy AS (   SELECT      "case_barcode",      "chromosome",      "start_pos",      "end_pos",      MAX("copy_number") AS "copy_number"   FROM      "TCGA_MITELMAN"."TCGA_VERSIONED"."COPY_NUMBER_SEGMENT_ALLELIC_HG38_GDC_R23"   WHERE      "project_short_name" = 'TCGA-LAML'   GROUP BY      "case_barcode",      "chromosome",      "start_pos",      "end_pos" ), total_cases AS (   SELECT COUNT(DISTINCT "case_barcode") AS "total"   FROM copy ), cytob AS (   SELECT      "chromosome",      "cytoband_name",      "hg38_start",      "hg38_stop"   FROM      "TCGA_MITELMAN"."PROD"."CYTOBANDS_HG38" ), joined AS (   SELECT      cytob."chromosome",      cytob."cytoband_name",      cytob."hg38_start",      cytob."hg38_stop",      copy."case_barcode",     (ABS(cytob."hg38_stop" - cytob."hg38_start") + ABS(copy."end_pos" - copy."start_pos")        - ABS(cytob."hg38_stop" - copy."end_pos") - ABS(cytob."hg38_start" - copy."start_pos")) / 2.0 AS "overlap",      copy."copy_number"   FROM      copy   LEFT JOIN      cytob   ON      cytob."chromosome" = copy."chromosome"   WHERE      (cytob."hg38_start" >= copy."start_pos" AND copy."end_pos" >= cytob."hg38_start")     OR (copy."start_pos" >= cytob."hg38_start" AND copy."start_pos" <= cytob."hg38_stop") ), INFO AS (   SELECT      "chromosome",      "cytoband_name",      "hg38_start",      "hg38_stop",      "case_barcode",     ROUND(SUM("overlap" * "copy_number") / SUM("overlap")) AS "copy_number"   FROM      joined   GROUP BY      "chromosome", "cytoband_name", "hg38_start", "hg38_stop", "case_barcode" )  SELECT    "case_barcode" FROM    INFO WHERE    "chromosome" = 'chr15'    AND "cytoband_name" = '15q11' ORDER BY    "copy_number" DESC LIMIT 1;