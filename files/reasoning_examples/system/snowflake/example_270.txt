# [Question]: How large are the DICOM image files with SEG or RTSTRUCT modalities and the SOP Class UID "1.2.840.10008.5.1.4.1.1.66.4", when grouped by collection, study, and series IDs, if they have no references to other series, images, or sources? Can you also provide a viewer URL formatted as "https://viewer.imaging.datacommons.cancer.gov/viewer/" followed by the study ID, and list these sizes in kilobytes, sorted from largest to smallest?
# [Schema links]: ['DICOM_ALL.collection_id', 'DICOM_ALL.StudyInstanceUID', 'DICOM_ALL.SeriesInstanceUID', 'DICOM_ALL.instance_size', 'DICOM_ALL.Modality', 'DICOM_ALL.SOPClassUID', 'DICOM_ALL.ReferencedSeriesSequence', 'DICOM_ALL.ReferencedImageSequence', 'DICOM_ALL.SourceImageSequence']
# [Analysis]: # Output: Letâ€™s think step by step.
1. Identify the relevant table: `DICOM_ALL` with columns `collection_id`, `StudyInstanceUID`, `SeriesInstanceUID`, `instance_size`, `Modality`, `SOPClassUID`, `ReferencedSeriesSequence`, `ReferencedImageSequence`, and `SourceImageSequence`.
2. Filter rows where `Modality` is either 'SEG' or 'RTSTRUCT', and `SOPClassUID` equals '1.2.840.10008.5.1.4.1.1.66.4'.
3. Further filter rows where there are no references: check that `ReferencedSeriesSequence`, `ReferencedImageSequence`, and `SourceImageSequence` arrays have size 0 using `ARRAY_SIZE(...) = 0`.
4. Create a CTE named `seg_rtstruct` to store the filtered results, including the computed `viewer_url` by concatenating the base URL with `StudyInstanceUID`.
5. From the CTE, group the results by `collection_id`, `StudyInstanceUID`, `SeriesInstanceUID`, and `viewer_url` to aggregate the file sizes per group.
6. Calculate the total instance size in kilobytes for each group by summing `instance_size` and dividing by 1024.
7. Order the final results by `collection_size_KB` in descending order.
# [Sql]: WITH seg_rtstruct AS (   SELECT     "collection_id",     "StudyInstanceUID",     "SeriesInstanceUID",     CONCAT('https://viewer.imaging.datacommons.cancer.gov/viewer/', "StudyInstanceUID") AS "viewer_url",     "instance_size"   FROM     "IDC"."IDC_V17"."DICOM_ALL"   WHERE     "Modality" IN ('SEG', 'RTSTRUCT')     AND "SOPClassUID" = '1.2.840.10008.5.1.4.1.1.66.4'     AND ARRAY_SIZE("ReferencedSeriesSequence") = 0     AND ARRAY_SIZE("ReferencedImageSequence") = 0     AND ARRAY_SIZE("SourceImageSequence") = 0 )  SELECT   seg_rtstruct."collection_id",   seg_rtstruct."SeriesInstanceUID",   seg_rtstruct."StudyInstanceUID",   seg_rtstruct."viewer_url",   SUM(seg_rtstruct."instance_size") / 1024 AS "collection_size_KB" FROM   seg_rtstruct GROUP BY   seg_rtstruct."collection_id",   seg_rtstruct."SeriesInstanceUID",   seg_rtstruct."StudyInstanceUID",   seg_rtstruct."viewer_url" ORDER BY   "collection_size_KB" DESC;