# [Question]: Calculate the annual differences in Bitcoin output value averages between two methods: Merged input/output records: Combine the inputs and outputs tables, filter to only output records, and calculate yearly averages. Transactions table: Directly use the output_value field from the transactions table for yearly averages. Show the difference (merged outputs average minus transactions average) only for years with data in both methods.
# [Schema links]: ["INPUTS.block_timestamp", "INPUTS.value", "OUTPUTS.block_timestamp", "OUTPUTS.value", "TRANSACTIONS.block_timestamp", "TRANSACTIONS.output_value"]
# [Analysis]: Let’s think step by step.
1. Combine the `INPUTS` and `OUTPUTS` tables into a unified dataset with a `type` column to distinguish input/output records using a `UNION ALL`.
2. Filter the combined dataset to retain only records where `type` is 'output', creating a filtered dataset of output records.
3. Extract the year from the `timestamp` of the filtered output records and calculate the average `value` for each year to form the first method's averages.
4. Extract the year from the `block_timestamp` of the `TRANSACTIONS` table and calculate the average `output_value` for each year to form the second method's averages.
5. Join the two average datasets on the `year` to identify overlapping years where both methods have data.
6. Compute the difference between the first method's average value and the second method's average value for each common year.
7. Select the `year` and calculated difference, ordering the results by year.
# [Sql]: WITH all_transactions AS (     SELECT          TO_TIMESTAMP_NTZ("block_timestamp" / 1000000) AS "timestamp",  -- 将时间戳转换为日期时间格式         "value",         'input' AS "type"     FROM          "CRYPTO"."CRYPTO_BITCOIN"."INPUTS"     UNION ALL     SELECT          TO_TIMESTAMP_NTZ("block_timestamp" / 1000000) AS "timestamp",  -- 将时间戳转换为日期时间格式         "value",         'output' AS "type"     FROM          "CRYPTO"."CRYPTO_BITCOIN"."OUTPUTS" ), filtered_transactions AS (     SELECT         EXTRACT(YEAR FROM "timestamp") AS "year",         "value"     FROM          all_transactions     WHERE "type" = 'output' ), average_output_values AS (     SELECT         "year",         AVG("value") AS "avg_value"     FROM          filtered_transactions     GROUP BY "year" ), average_transaction_values AS (     SELECT          EXTRACT(YEAR FROM TO_TIMESTAMP_NTZ("block_timestamp" / 1000000)) AS "year",  -- 同样转换时间戳         AVG("output_value") AS "avg_transaction_value"      FROM          "CRYPTO"."CRYPTO_BITCOIN"."TRANSACTIONS"      GROUP BY "year"      ORDER BY "year" ), common_years AS (     SELECT         ao."year",         ao."avg_value" AS "avg_output_value",         atv."avg_transaction_value"     FROM         average_output_values ao     JOIN         average_transaction_values atv          ON ao."year" = atv."year" )  SELECT     "year",     "avg_transaction_value" - "avg_output_value" AS "difference" FROM     common_years ORDER BY     "year";