# [Question]: Determine the population distribution within each block group relative to its census tract in New York State using 2021 ACS data. Include block group ID, census value, state county tract ID, total tract population, and the population ratio of each block group.
# [Schema links]: ["PUBLIC.Dim_CensusGeography.BlockGroupID", "PUBLIC.Fact_CensusValues_ACS2021.CensusValue", "PUBLIC.Dim_CensusGeography.StateCountyTractID", "PUBLIC.Dim_CensusGeography.StateAbbrev", "PUBLIC.Fact_CensusValues_ACS2021.MetricID"]
# [Analysis]: Letâ€™s think step by step.
1. Identify the relevant tables and columns: `Dim_CensusGeography` (BlockGroupID, StateCountyTractID, StateAbbrev) and `Fact_CensusValues_ACS2021` (CensusValue, MetricID).
2. Filter for New York State by setting `StateAbbrev = 'NY'` and population metric using `MetricID = 'B01003_001E'`.
3. Join `Dim_CensusGeography` and `Fact_CensusValues_ACS2021` on `BlockGroupID` to link block group geography with population data.
4. Create a CTE (`TractPop`) to store individual block group population values with their tract identifiers.
5. Create a second CTE (`TractGroup`) to calculate total tract population by aggregating block group populations per `StateCountyTractID`.
6. Join `TractPop` and `TractGroup` on `StateCountyTractID` to associate each block group with its tract's total population.
7. Calculate the population ratio by dividing block group population (`CensusValue`) by tract total population (`TotalTractPop`), handling division by zero with a `CASE` statement.
8. Select the required fields: `BlockGroupID`, `CensusValue`, `StateCountyTractID`, `TotalTractPop`, and the computed `PopulationRatio`.
# [Sql]: WITH TractPop AS (     SELECT         CG."BlockGroupID",         FCV."CensusValue",         CG."StateCountyTractID"     FROM         "CENSUS_GALAXY__ZIP_CODE_TO_BLOCK_GROUP_SAMPLE"."PUBLIC"."Dim_CensusGeography" CG     JOIN         "CENSUS_GALAXY__ZIP_CODE_TO_BLOCK_GROUP_SAMPLE"."PUBLIC"."Fact_CensusValues_ACS2021" FCV     ON         CG."BlockGroupID" = FCV."BlockGroupID"     WHERE         CG."StateAbbrev" = 'NY'         AND FCV."MetricID" = 'B01003_001E' ), TractGroup AS (     SELECT         CG."StateCountyTractID",         SUM(FCV."CensusValue") AS "TotalTractPop"     FROM         "CENSUS_GALAXY__ZIP_CODE_TO_BLOCK_GROUP_SAMPLE"."PUBLIC"."Dim_CensusGeography" CG     JOIN         "CENSUS_GALAXY__ZIP_CODE_TO_BLOCK_GROUP_SAMPLE"."PUBLIC"."Fact_CensusValues_ACS2021" FCV     ON         CG."BlockGroupID" = FCV."BlockGroupID"     WHERE         CG."StateAbbrev" = 'NY'         AND FCV."MetricID" = 'B01003_001E'     GROUP BY         CG."StateCountyTractID" ) SELECT     TP."BlockGroupID",     TP."CensusValue",     TP."StateCountyTractID",     TG."TotalTractPop",     CASE         WHEN TG."TotalTractPop" != 0 THEN TP."CensusValue" / TG."TotalTractPop"         ELSE 0     END AS "PopulationRatio" FROM     TractPop TP JOIN     TractGroup TG ON     TP."StateCountyTractID" = TG."StateCountyTractID";